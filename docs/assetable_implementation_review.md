# Assetable 実装状況チェックレポート

## 1. はじめに

本ドキュメントは、現在開発中の`assetable`ツールについて、提供された仕様書と現状のソースコードを比較し、実装の充足度、潜在的な課題、および仕様漏れの有無を評価した結果をまとめたものです。

## 2. 総合評価

全体として、`assetable`は仕様書に沿って非常によく設計・実装されています。特に以下の点は高く評価できます。

-   **堅牢なアーキテクチャ**: ファイルベースの状態管理、Pydanticによる型安全な設定とデータモデル、責務が分離されたパイプラインエンジンなど、仕様書で定義されたアーキテクチャが忠実に実装されています。
-   **高い拡張性**: 各処理ステップが独立したクラスとして定義されており、将来的な機能追加や変更が容易な構造になっています。
-   **明確なコード**: `src`ディレクトリ構造の採用、`ruff`や`pyright`といったツールによるコード品質の維持が徹底されており、可読性とメンテナンス性が高いコードベースです。

コンセプトである「**本のスキャンデータを、AIも人間も読めるデジタル資産に変える**」ための基盤は、ほぼ完成していると言えます。

## 3. 主要コンポーネントの実装状況チェック

| コンポーネント | ファイル | 評価 | 備考 |
| :--- | :--- | :--- | :--- |
| **設定管理** | `config.py` | ✅ 完了 | Pydanticによる型安全な設定クラス。環境変数からの読み込みや動的なパス生成など、実用的な機能が網羅されています。 |
| **データモデル** | `models.py` | ✅ 完了 | `PageData`を中心に、パイプラインを流れるデータが段階的に拡張される設計が見事に実装されています。各モデルの責務も明確です。 |
| **CLI** | `cli.py` | ✅ 完了 | `typer`を使用し、多機能で分かりやすいCLIが実装されています。各コマンドが仕様書の要件に沿っており、ユーザーフレンドリーです。 |
| **パイプラインエンジン** | `pipeline/engine.py` | ✅ 完了 | `PipelineStep`抽象クラスと`PipelineEngine`による実行制御は、責務分離が明確で拡張性の高い優れた設計です。 |
| **AIプロンプト** | `ai/prompts.py` | ✅ 完了 | 3段階のAI処理に対応したプロンプトが詳細に定義されており、仕様書の要件をよく反映しています。 |
| **AIクライアント** | `ai/ollama_client.py` | ⚠️ 要確認 | Ollamaとの通信、リトライロジックの基本実装は完了していますが、タイムアウト設定に潜在的な課題があります。（詳細は後述） |
| **AI処理** | `ai/vision_processor.py` | ✅ 完了 | 3段階のAI処理（構造解析、アセット抽出、Markdown生成）を明確に実装しており、プロンプト生成やエラーハンドリングも考慮されています。 |
| **ファイル状態管理** | `file_manager.py` | ⚠️ 要対応 | 個別ファイルの保存・読み込み機能は実装済みですが、仕様書にある「画像のクリッピング」処理が欠落しています。（詳細は後述） |
| **パイプライン定義** | `pipeline/pipeline.py` | ❌ 未実装 | ファイルは存在するものの、中身が空です。現状は`engine.py`がロジックを担っていますが、役割が不明確です。 |

## 4. 仕様書との比較による実装漏れ・改善点の指摘

分析の結果、以下の3点が主要な実装漏れおよび改善点として特定されました。

### 4.1. 【要対応】画像のクリッピング機能の欠如

-   **現状**:
    -   `ai/vision_processor.py`は、AIを用いて画像内の特定領域の**バウンディングボックス（座標）**をJSONとして特定します。
    -   `file_manager.py`の`_save_image_asset`メソッドは、このバウンディングボックスを含むメタデータをJSONファイルとして保存するのみです。
-   **仕様とのギャップ**:
    -   仕様書には「**画像→画像のクリッピング（PDFのツール等を使用？**）」と明記されており、特定した領域を実際の画像ファイルとして切り出して保存する機能が必須です。
-   **影響**:
    -   現状では、Markdownから参照されるべき個別の画像ファイルが生成されず、ツールとしての価値が大きく損なわれています。

### 4.2. 【要確認】Ollamaクライアントのタイムアウト設定

-   **現状**:
    -   `ai/ollama_client.py`内で、`ollama-python`ライブラリの`chat`メソッドを呼び出していますが、`timeout`パラメータが設定されていません（コード内でコメントアウトされています）。
-   **仕様とのギャップ**:
    -   仕様書ではパフォーマンスについて「最低限、ollamaが動作するのであれば動くようにする」とされていますが、タイムアウトが設定されていない場合、AIモデルの応答が予期せず長引いた際にプロセスがハングアップするリスクがあります。
-   **影響**:
    -   ツールの安定性が低下し、長時間応答がない場合にユーザーが原因を特定するのが困難になります。

### 4.3. 【提案】パイプラインロジックのリファクタリング

-   **現状**:
    -   `pipeline/pipeline.py`ファイルが空のままです。
    -   `cli.py`内の`pipeline`コマンドに、`PipelineEngine`の初期化や実行制御などのビジネスロジックが直接記述されています。
-   **仕様とのギャップ**:
    -   仕様書では「パイプライン実行エンジン：各処理ステップのロジックと、それらを実行する順序・制御のロジックを完全に分離させる」とあり、現状でも分離はされていますが、責務分担の点で改善の余地があります。
-   **提案**:
    -   `pipeline/pipeline.py`に、`cli.py`から呼び出すための高レベルなパイプライン実行関数（例: `run_full_pipeline`）を実装します。
    -   `cli.py`はユーザー入力の解析と、この高レベル関数の呼び出しに専念させることで、UI層とビジネスロジック層の分離がより明確になり、コードの可読性とメンテナンス性が向上します。

## 5. まとめと推奨事項

`assetable`プロジェクトは、そのコンセプトとアーキテクチャ設計を見事にコードに反映させており、非常に高い完成度を誇ります。

今後は、指摘された実装漏れ、特に最優先である**画像のクリッピング機能の実装**に取り組むことで、ツールとしての必須要件を満たすことができます。その後、タイムアウト設定の確認とパイプラインロジックのリファクタリングを行うことで、より堅牢でメンテナンス性の高いアプリケーションへと進化させることができるでしょう。
